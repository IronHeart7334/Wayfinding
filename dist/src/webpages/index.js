!function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(){this.draw=void 0,this.image=void 0,this.destWidth=0,this.destHeight=0,this.sourceMinX=0,this.sourceMinY=0,this.sourceMaxX=0,this.sourceMaxY=0,this.color=void 0}link(t){this.draw=t}async setImage(t){return new Promise((e,s)=>{this.image=this.draw.image(t),this.image.loaded(()=>{this.resize(),e()})})}setColor(t){this.color=t}clear(){let t=this.draw.children();for(let e=t.length-1;e>=0;e--)"rect"!==t[e].type&&"line"!==t[e].type&&"text"!==t[e].type||t[e].remove()}rect(t,e,s,i){return this.draw.rect(s,i).attr({fill:this.color}).move(this.x(t),this.y(e))}text(t,e,s){return this.draw.text(t.toString()).move(this.x(e)-10,this.y(s)-20).attr({fill:this.color})}line(t,e,s,i){return this.draw.line(this.x(t),this.y(e),this.x(s),this.y(i)).stroke({color:this.color,width:3})}setCorners(t,e,s,i){this.sourceMinX=t,this.sourceMinY=e,this.sourceMaxX=s,this.sourceMaxY=i,this.calcSize()}resize(){this.destWidth=this.image.node.width.baseVal.value,this.destHeight=this.image.node.height.baseVal.value}calcSize(){this.mapWidth=this.sourceMaxX-this.sourceMinX,this.mapHeight=this.sourceMaxY-this.sourceMinY}x(t){return(t-this.sourceMinX)/this.mapWidth*this.destWidth}y(t){return(t-this.sourceMinY)/this.mapHeight*this.destHeight}}class n{constructor(t,e,s){this.mode=s.mode,this.startId=parseInt(t),this.endId=parseInt(e),this.dataSource=s,this.valid=!0,this.idPath=[],this.nodePath=[],this.pathLength=0,this.loadPath(),this.decodeIds()}decodeIds(){this.nodePath=[];for(let t=0;t<this.idPath.length;t++)this.nodePath[t]=this.dataSource.getNodeDB().getNode(this.idPath[t])}loadPath(){if(this.startId===this.endId)return this.idPath=[this.startId],void(this.pathLength=0);let t=this.dataSource.getNodeDB(),e=t.getAll(),s=[],i={},n={};for(let t=0;t<e.length;t++)s[t]=e[t],i[e[t].id]=1/0,n[e[t].id]=void 0;function o(){let t=0;for(let e=0;e<s.length;e++)i[s[e].id]<i[s[t].id]&&(t=e);return t}for(i[this.startId]=0;s.length>0;){let e=o(),r=s[e];s.splice(e,1);for(let e=0;e<r.adj.length;e++)if(s.includes(r.adj[e])){let s=i[r.id]+r.distanceFrom(r.adj[e]);(i[r.adj[e].id]===1/0||s<r.adj[e].distanceFrom(t.getNode(this.startId)))&&(i[r.adj[e].id]=s,n[r.adj[e].id]=r.id)}}let r=[],a=this.endId;for(;void 0!==n[a];)r.push(a),a=n[a];-1!==t.getNode(this.startId).adjIds.indexOf(r[r.length-1])&&r.push(this.startId),r=r.reverse(),this.idPath=r,this.pathLength=i[this.endId],this.startId===this.idPath[0]&&this.endId===this.idPath[this.idPath.length-1]||this.invalidate(),(this.startId<0||this.endId<0)&&this.invalidate()}invalidate(){if(this.valid){this.valid=!1;try{throw console.log("Invalid path detected: "),console.log(this),new Error}catch(t){console.log(t.stack)}}}getURL(){return window.location.href.split("?")[0]+"?startID="+this.idPath[0]+"&endID="+this.idPath[this.idPath.length-1]+"&mode="+this.mode}draw(t){t.clear(),t.setColor("red");let e=this.nodePath;e[0].draw(t);for(let s=1;s<e.length;s++)t.line(e[s-1].x,e[s-1].y,e[s].x,e[s].y),e[s].draw(t)}}function o(){const t=window.location.href;let e=new Map;if(e.set("startID",14),e.set("endID",96),e.set("mode","WAYFINDING"),e.set("dev",!1),t.indexOf("?")>-1){let s=t.split("?")[1].split("&");for(let t=0;t<s.length;t++){let i=s[t].split("=");i[0].toUpperCase().includes("START")?e.set("startID",i[1]):i[0].toUpperCase().includes("END")?e.set("endID",i[1]):i[0].toUpperCase().includes("MODE")?e.set("mode",i[1].toUpperCase()):i[0].toUpperCase().includes("DEV")&&e.set("dev",!0)}}return e}class r{constructor(t,e,s){try{if(this.id=parseInt(t),isNaN(this.id))throw new TypeError("Node id must be an integer")}catch(t){console.log(t.stack)}try{if(this.x=parseFloat(e),this.y=parseFloat(s),isNaN(this.x)||isNaN(this.y))throw new TypeError("X and Y must be numbers")}catch(t){console.log(t)}this.adjIds=[]}loadAdj(t){let e;this.adj=[];for(let s=0;s<this.adjIds.length;s++)(e=t.getNode(this.adjIds[s]))&&this.adj.push(e)}distanceFrom(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}addAdjId(t){this.adjIds.push(t)}draw(t){t.setColor("red"),t.rect(this.x,this.y,5,5)}drawId(t){t.setColor("red"),t.text(this.id,this.x,this.y)}drawLinks(t){t.setColor("red"),this.drawId(t);for(let e=0;e<this.adj.length;e++)this.adj[e].draw(t),t.line(this.x,this.y,this.adj[e].x,this.adj[e].y)}generateDiv(t){let e=this,s=t.getCanvas();e.drawId(s),s.rect(this.x,this.y,10,10).mouseover(function(){e.draw(s),e.drawLinks(s)}).mouseout(function(){s.clear();let e=t.getPath();void 0!==e&&e.draw(s),t.getNodeDB().generateDivs(t)}).click(function(){console.log(e)})}}function a(t){let e=[];try{(Array.isArray(t)?t:t.split(/\r?\n|\r/)).forEach(t=>{e.push(Array.isArray(t)?t:t.split(","))})}catch(e){console.log(e.stack),console.log("response text is: "),console.log(t)}return e}class l{constructor(){this.nodes=new Map,this.stuffToNodeId=new Map}parseNodeData(t){let e,s,i,n,o=a(t),l=[];for(let t=1;t<o.length;t++)e=o[t],s=parseInt(e[0]),i=parseFloat(e[1]),n=parseFloat(e[2]),isNaN(s)||isNaN(i)||isNaN(n)?l.push("An error occured for the line "+e.join()):this.nodes.set(s,new r(s,i,n));l.length>0&&(console.log("Something went wrong with parsing the node data:"),l.forEach(t=>console.log("--"+t)))}parseNameToId(t){let e,s,i=this;a(t).forEach(t=>{try{e=t[0].toString().toUpperCase(),s=parseInt(t[1]),isNaN(s)||i.stuffToNodeId.set(e,s)}catch(e){console.log("Invalid row: "+t),console.log(e.message)}})}parseConnData(t){let e,s=a(t);for(let t=1;t<s.length;t++){e=s[t];try{this.getNode(parseInt(e[0])).addAdjId(parseInt(e[1]))}catch(t){console.log("Node not found: "+parseInt(e[1])),console.log(t.stack)}}let i=this;this.getAll().forEach(t=>t.loadAdj(i))}getNode(t){let e=null;try{if(!((e=this.nodes.get(parseInt(t)))instanceof r))throw Error("Node with id of "+t+" does not exist")}catch(t){console.log(t.stack)}return e}getIdByString(t){let e=this.stuffToNodeId.get(t.toString().toUpperCase());return void 0===e&&console.log("Couldn't find node identified by "+t),e}getStringsById(t){let e=[];return this.stuffToNodeId.forEach((s,i)=>{s===t&&e.push(i)}),e}getAllNames(){return Array.from(this.stuffToNodeId.keys())}getAll(){return Array.from(this.nodes.values())}prettyPrintStuffToId(){let t=0;this.getAllNames().forEach(e=>{e.length>t&&(t=e.length)});let e,s=0,i=" ";this.stuffToNodeId.forEach((n,o)=>{for(s=t-o.length,i=" ",e=0;e<s;e++)i+=" ";console.log(o+i+n)})}generateDivs(t){this.getAll().forEach(e=>e.generateDiv(t))}drawAll(t){this.getAll().forEach(e=>{e.draw(t),e.drawLinks(t)})}}class d{constructor(){this.canvas=void 0,this.start=void 0,this.end=void 0,this.pathButton=void 0,this.infoElement=void 0,this.currentPath=void 0,this.nodeDatabase=new l,this.mode="WAYFINDING"}setCanvas(t){this.canvas=t}getCanvas(){return this.canvas}setInput(t,e){this.start=t,this.end=e}setInfoElement(t){this.infoElement=t}setPathButton(t){this.pathButton=document.getElementById(t),null===this.pathButton&&(this.pathButton=document.createElement("button"),this.pathButton.setAttribute("id",t),this.pathButton.innerHTML="Draw Path",document.body.appendChild(this.pathButton));let e=this;this.pathButton.onclick=function(){e.start.isValid()&&e.end.isValid()?e.updatePath():console.log("Not valid: "+e.start.getResult()+" "+e.end.getResult())}}setPath(t){if(t.valid){this.currentPath=t,this.infoElement.update(this);try{t.draw(this.canvas)}catch(t){console.log("Main's canvas is not defined yet"),console.log(t.stack)}}else console.log("Not valid: "+t)}getPath(){return this.currentPath}updatePath(){try{let t=this.getNodeDB().getIdByString(this.start.getResult()),e=this.getNodeDB().getIdByString(this.end.getResult());if(null==t||null==e)throw new Error("Invalid start and end points: "+this.start.getResult()+" "+this.end.getResult());{let s=new n(t,e,this);if(!s.valid)throw new Error("Invalid path: "+s.idPath);this.setPath(s)}}catch(t){console.log(t.stack)}}addDevTools(){function t(t,e){let s=document.getElementById(t);null===s&&((s=document.createElement("div")).setAttribute("id",t),document.body.appendChild(s)),s.onclick=e,s.innerHTML=t}let e=this;t("Test all paths",()=>e.testAllPaths()),t("get current path URL",()=>document.getElementById("get current path URL").innerHTML=e.getPath().getURL())}saveAsSvg(){let t={name:this.currentPath.getURL()+".svg",mimeType:"image/svg+xml",parents:["176GK1W_9BOqWf0rHpM3cMNhQjSHIjfF2"]},e=new FormData;e.append("metadata",new Blob([JSON.stringify(t)],{type:"application/json"})),gapi.auth2.getAuthInstance().signIn().then(t=>{let s=new Headers({Authorization:"Bearer "+gapi.auth.getToken().access_token});fetch("https://www.googleapis.com/upload/drive/v3/files",{method:"POST",headers:s,body:e}).then(t=>{console.log(t),t.json().then(t=>{let e=t.id;console.log(e),fetch("https://www.googleapis.com/upload/drive/v3/files/"+e+"?uploadType=media",{method:"PATCH",headers:s,"Content-Type":"image/svg+xml",body:this.canvas.draw.svg()})})}).catch(t=>{console.log(t)})})}notifyImportDone(){let t=this.nodeDatabase.getNode(-1),e=this.nodeDatabase.getNode(-2),s=o();this.canvas.setCorners(t.x,t.y,e.x,e.y),this.start.addOptions(this.getNodeDB().getAllNames()),this.end.addOptions(this.getNodeDB().getAllNames()),this.setPath(new n(s.get("startID"),s.get("endID"),this)),s.get("dev")&&this.addDevTools()}testAllPaths(){let t=this,e=t.getNodeDB(),s=[];function i(s,i){try{let o=e.getIdByString(s),r=e.getIdByString(i);if(null!=o&&null!=r){let e=new n(o,r,t);if(!e.valid)throw new Error("Invalid Path: "+e.idPath)}}catch(t){console.log(t.stack)}}s=s.concat(e.getAllNames()),alert("Please wait while I process "+s.length*s.length+" paths...");for(let t=0;t<s.length;t++)for(let e=0;e<s.length;e++)i(s[t],s[e]);alert("Done.")}setNodeDB(t){this.nodeDatabase=t}getNodeDB(){return this.nodeDatabase}}class h{constructor(t,e){this.box=document.getElementById(t),this.resultElement=document.getElementById(e),null===this.box&&(this.box=document.createElement("input"),this.box.setAttribute("type","text"),this.box.setAttribute("id",t),document.body.appendChild(this.box)),null===this.resultElement&&(this.resultElement=document.createElement("div"),this.resultElement.setAttribute("id",e),document.body.appendChild(this.resultElement)),this.options=["your result will appear here!"],this.resultElement.innerHTML="your result will appear here!",this.box.oninput=this.updateResult.bind(this)}addOptions(t){let e=this;Array.isArray(t)||(t=[t]),t.forEach(t=>{t&&e.options.push(t.toString().toUpperCase())})}updateResult(){this.resultElement.innerHTML=function(t,e){let s,i=t.trim().toUpperCase(),n=[],o=0,r=t.length,a=e[0];for(let t=0;t<e.length;t++)n.push(e[t].trim().toUpperCase()),(s=c(i,n[t])).matches>o?(o=s.matches,r=s.spaces,a=e[t]):s.matches===o&&s.spaces<r&&(o=s.matches,r=s.spaces,a=e[t]);return a}(this.box.value,this.options)}isValid(){return this.options.indexOf(this.resultElement.innerText.toUpperCase())>0}setInput(t){this.box.value=t,this.box.oninput()}getResult(){return this.resultElement.innerText}}function c(t,e){t=t.toUpperCase(),e=e.toUpperCase();let s,i,n,o=0,r=0;for(let a=0;a<t.length-o;a++){i=0,n=0,s=0;for(let o=0;o<e.length&&a+i<t.length;o++)t[a+i]===e[o]&&(n+=++i>1?o-s-1:o,s=o);i>o&&(o=i,r=n)}return{matches:o,spaces:r}}class u{constructor(t){this.element=document.getElementById(t),null===this.element&&(this.element=document.createElement("ul"),this.element.setAttribute("id",t),document.body.appendChild(this.element))}update(t){let e=t.getNodeDB(),s=t.getPath();for(;this.element.hasChildNodes();)this.element.removeChild(this.element.childNodes[0]);e.getStringsById(s.endId).forEach(t=>{if((t=t.toLowerCase()).includes("http")){let e=document.createElement("li"),s=document.createElement("a");s.innerHTML=t,s.setAttribute("href",t),s.setAttribute("target","_blank"),e.appendChild(s),this.element.appendChild(e)}})}}const g=/\r?\n|\r/,p="https://drive.google.com/export=download?id=1Q99ku0cMctu3kTN9OerjFsM9Aj-nW6H5",f={contents:[],add(t){this.contents.push(t)},displayAll(){for(let t=0;t<this.contents.length;t++)console.log(this.contents[t])}};async function m(t){return new Promise((e,s)=>{gapi.client.drive.files.get({fileId:t}).then(s=>{s.result.mimeType.includes("image")?e("https://drive.google.com/uc?export=download&id="+s.result.id):gapi.client.drive.files.get({fileId:t,alt:"media"}).then(s=>{f.add("Response from "+t+":"),f.add(s),f.add(s.body),e(s.body)}).catch(t=>{throw new Error(t)})}).catch(t=>{throw new Error(t)})})}async function y(t){return new Promise((e,s)=>{m(t).then(t=>{let s=a(t),i=new Map;for(let t=1;t<s.length;t++)s[t].length>=2&&""!==s[t][1]&&(s[t][1].indexOf("id=")>-1?i.set(s[t][1].split("id=")[1],s[t][0]):i.set(s[t][1],s[t][0]));(async function(t){return new Promise((e,s)=>{let i=new Map,n=0;for(let s=0;s<t.length;s++)i.set(t[s],"No response from file ID "+t[s]),m(t[s]).then(o=>{i.set(t[s],o),++n===t.length&&e(i)})})})(Array.from(i.keys())).then(t=>{let s=new Map;t.forEach((t,e)=>{s.set(i.get(e),t)}),e(s)})})})}async function w(){let t=-1===p.indexOf("id=")?p:p.split("id=")[1];return new Promise((e,s)=>{m(t).then(t=>{let s=t.split(g);(s=s.map(t=>t.split(",")))[0]=s[0].map(t=>t.toUpperCase());let i,n,r=s[0].indexOf(o().get("mode"));-1===r&&(r=0),function t(o,r){0===o&&0===r?console.log("No valid manifests exist. Something went very wrong."):0===o?(console.log("No valid manifests were found for "+s[o][r]+". Switching to default wayfinding."),t(s.length-1,0)):""===s[o][r]?t(o-1,r):(i=s[o][r],async function(t){return gapi.client.drive.files.get({fileId:t}).then(()=>!0).catch(()=>!1)}(n=-1===i.indexOf("id=")?i:i.split("id=")[1]).then(s=>{s?e(n):t(o-1,r)}))}(s.length-1,r)}).catch(t=>{console.log(t)})})}function I(){let t=new d,e=new h("start box","start hint"),s=new h("end box","end hint"),n=new u("moreInfo"),r=SVG("wrapper").size(1e3,1e3).panZoom(),a=new i;a.link(r),t.setCanvas(a),t.setInput(e,s),t.setInfoElement(n),t.setPathButton("button"),async function(t){t.mode=o().get("mode"),new Promise((e,s)=>{w().then(s=>{y(s).then(s=>{let i=t.getNodeDB();t.getCanvas(),i.parseNodeData(s.get("Node coordinates")),i.parseConnData(s.get("Node connections")),i.parseNameToId(s.get("labels")),t.getCanvas().setImage(s.get("map image")).then(()=>{t.notifyImportDone(),e(s)})})})})}(t)}s.d(e,"init",function(){return I}),document.getElementById("wrapper").onload=function(){I()}}]);